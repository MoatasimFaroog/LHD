# Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù† Ø·Ø±ÙŠÙ‚ RunPod (Node.js + React)
# Build Application via RunPod (Node.js + React)

name: Build via RunPod

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  # Ø¨Ø¯Ø¡ Ø§Ù„Ù€ runner Ø¹Ù„Ù‰ RunPod
  # Start self-hosted runner on RunPod
  start-runner:
    name: Start RunPod Runner
    runs-on: ubuntu-latest
    outputs:
      pod_id: ${{ steps.start-pod.outputs.pod_id }}
      runner_label: ${{ steps.start-pod.outputs.runner_label }}
    steps:
      # Ø¨Ø¯Ø¡ pod Ø¹Ù„Ù‰ RunPod ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ GitHub Actions runner
      # Start a RunPod pod and register it as a GitHub Actions runner
      - name: Start RunPod pod as GitHub Actions runner
        id: start-pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          RUNNER_LABEL="runpod-${{ github.run_id }}"

          # Ø¥Ø·Ù„Ø§Ù‚ pod Ø¹Ù„Ù‰ RunPod Ù…Ø¹ ØµÙˆØ±Ø© GitHub Actions runner
          # Launch a RunPod pod with the GitHub Actions runner image
          RESPONSE=$(curl -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RUNPOD_API_KEY" \
            "https://api.runpod.io/graphql" \
            --data-raw "{
              \"query\": \"mutation { podFindAndDeployOnDemand(input: { cloudType: SECURE, gpuCount: 0, volumeInGb: 0, containerDiskInGb: 20, minMemoryInGb: 8, minVcpuCount: 4, imageName: \\\"myoung34/github-runner:latest\\\", env: [{ key: \\\"ACCESS_TOKEN\\\", value: \\\"$GH_PAT\\\" }, { key: \\\"REPO_URL\\\", value: \\\"https://github.com/${{ github.repository }}\\\" }, { key: \\\"RUNNER_NAME\\\", value: \\\"$RUNNER_LABEL\\\" }, { key: \\\"RUNNER_LABELS\\\", value: \\\"$RUNNER_LABEL\\\" }, { key: \\\"RUNNER_SCOPE\\\", value: \\\"repo\\\" }, { key: \\\"EPHEMERAL\\\", value: \\\"1\\\" }] }) { id } }\"
            }")

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ pod
          # Validate pod creation response
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âŒ RunPod API error:"
            echo "$RESPONSE" | jq '.errors'
            exit 1
          fi

          POD_ID=$(echo "$RESPONSE" | jq -r '.data.podFindAndDeployOnDemand.id // empty')
          if [ -z "$POD_ID" ]; then
            echo "âŒ Failed to start RunPod pod. API response:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "pod_id=$POD_ID" >> $GITHUB_OUTPUT
          echo "runner_label=$RUNNER_LABEL" >> $GITHUB_OUTPUT
          echo "âœ… Started RunPod pod: $POD_ID"
          echo "ğŸ·ï¸ Runner label: $RUNNER_LABEL"

      # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ø§Ù„Ù€ runner Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ø¨Ø± ÙØ­Øµ Ø¯ÙˆØ±ÙŠ
      # Poll until the runner comes online (up to 10 minutes)
      - name: Wait for runner to come online
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          RUNNER_LABEL: ${{ steps.start-pod.outputs.runner_label }}
        run: |
          echo "â³ Waiting for RunPod runner ($RUNNER_LABEL) to come online..."
          TIMEOUT=600
          ELAPSED=0
          INTERVAL=15
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(curl -s \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners" \
              | jq -r --arg label "$RUNNER_LABEL" \
                '.runners[] | select(.labels[].name == $label) | .status' 2>/dev/null || true)
            if [ "$STATUS" = "online" ]; then
              echo "âœ… Runner is online!"
              exit 0
            fi
            echo "â³ Runner not yet online (${ELAPSED}s elapsed), retrying in ${INTERVAL}s..."
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          echo "âŒ Timed out waiting for runner to come online after ${TIMEOUT}s"
          exit 1

  # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù„Ù‰ RunPod
  # Build the project on RunPod
  build:
    name: Build Application on RunPod
    needs: start-runner
    runs-on: ${{ needs.start-runner.outputs.runner_label }}
    timeout-minutes: 30
    steps:
      # Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node 22 Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¯Ø¹Ù… import.meta.dirname Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ server/vite.ts
          node-version: '22.x'
          cache: 'npm'

      # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Frontend + Backend)
      # Build the project (Frontend + Backend)
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      # Ø±ÙØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ù†Ø§Ø¡
      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runpod-build-output
          path: dist
          retention-days: 7

      # Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
      # Display build summary
      - name: Build Summary
        if: always()
        run: |
          echo "ğŸš€ RunPod Build Complete!"
          if [ -d "dist" ]; then
            echo "âœ… Build successful"
            echo "ğŸ“¦ Build output:"
            ls -lh dist/
          else
            echo "âŒ Build failed - dist directory not found"
          fi

  # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ runner ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù€ pod
  # Stop runner and terminate the pod
  stop-runner:
    name: Stop RunPod Runner
    needs:
      - start-runner
      - build
    runs-on: ubuntu-latest
    if: always()
    steps:
      # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù€ pod Ø¹Ù„Ù‰ RunPod Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
      # Terminate the RunPod pod after build completes
      - name: Terminate RunPod pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          POD_ID: ${{ needs.start-runner.outputs.pod_id }}
        run: |
          TERMINATE_RESPONSE=$(curl -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RUNPOD_API_KEY" \
            "https://api.runpod.io/graphql" \
            --data-raw "{\"query\": \"mutation { podTerminate(input: { podId: \\\"$POD_ID\\\" }) }\"}")
          if echo "$TERMINATE_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âš ï¸ Warning: pod termination returned errors:"
            echo "$TERMINATE_RESPONSE" | jq '.errors'
          else
            echo "ğŸ›‘ Terminated RunPod pod: $POD_ID"
          fi
