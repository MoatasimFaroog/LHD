# Ø¨Ù†Ø§Ø¡ Unity Android APK Ø¹Ù† Ø·Ø±ÙŠÙ‚ RunPod
# Build Unity Android APK via RunPod (large disk / self-hosted runner)
#
# Ù„Ù…Ø§Ø°Ø§ RunPodØŸ / Why RunPod?
#   ÙŠØ­ØªØ§Ø¬ Unity Ø¥Ù„Ù‰ 40-60 GB Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø±Øµ (ØµÙˆØ±Ø© Docker + Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡).
#   ÙŠÙÙ…ÙƒÙ‘Ù† RunPod Ù…Ù† ØªÙˆÙÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¬Ù‡Ø§Ø² Ù…Ø­Ù„ÙŠ.
#
#   Unity needs 40-60 GB of disk space (Docker image + build Library).
#   RunPod provides this space without needing a powerful local machine.
#
# Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª / Requirements (GitHub Secrets):
#   RUNPOD_API_KEY  â€” Ù…ÙØªØ§Ø­ API Ù…Ù† runpod.io/console/user/settings
#   GH_PAT          â€” GitHub Personal Access Token (ØµÙ„Ø§Ø­ÙŠØ© repo)
#   UNITY_LICENSE   â€” Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù .ulf ÙƒØ§Ù…Ù„Ø§Ù‹
#   UNITY_EMAIL     â€” Ø¨Ø±ÙŠØ¯ Ø­Ø³Ø§Ø¨ Unity
#   UNITY_PASSWORD  â€” ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø­Ø³Ø§Ø¨ Unity

name: Build Unity Android APK (RunPod)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Ø§Ù„ÙˆØ¸ÙŠÙØ© 1: ØªØ´ØºÙŠÙ„ pod Ø¹Ù„Ù‰ RunPod ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ self-hosted runner
  # Job 1: Launch a RunPod pod and register it as a GitHub Actions runner
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  start-runner:
    name: Start RunPod Runner
    runs-on: ubuntu-latest
    outputs:
      pod_id: ${{ steps.start-pod.outputs.pod_id }}
      runner_label: ${{ steps.start-pod.outputs.runner_label }}
    steps:
      - name: Launch RunPod pod (60 GB disk, 16 GB RAM) as GitHub Actions runner
        id: start-pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          RUNNER_LABEL="runpod-unity-${{ github.run_id }}"

          # ÙŠØ­ØªØ§Ø¬ pod Ù„Ù€:
          #   containerDiskInGb: 60  â† ØµÙˆØ±Ø© Unity Docker (~20 GB) + Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (~30 GB)
          #   minMemoryInGb: 16      â† Unity ÙŠØ­ØªØ§Ø¬ Ø°Ø§ÙƒØ±Ø© ÙˆÙÙŠØ±Ø©
          #   minVcpuCount: 8        â† ØªØ³Ø±ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒÙ…Ø¨Ø§ÙŠÙ„
          #   imageName: myoung34/github-runner:ubuntu-jammy
          #              â† runner image ÙŠØªØ¶Ù…Ù† Docker Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ game-ci/unity-builder
          RESPONSE=$(curl -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RUNPOD_API_KEY" \
            "https://api.runpod.io/graphql" \
            --data-raw "{
              \"query\": \"mutation {
                podFindAndDeployOnDemand(input: {
                  cloudType: SECURE,
                  gpuCount: 0,
                  volumeInGb: 0,
                  containerDiskInGb: 60,
                  minMemoryInGb: 16,
                  minVcpuCount: 8,
                  imageName: \\\"myoung34/github-runner:ubuntu-jammy\\\",
                  env: [
                    { key: \\\"ACCESS_TOKEN\\\",   value: \\\"$GH_PAT\\\" },
                    { key: \\\"REPO_URL\\\",        value: \\\"https://github.com/${{ github.repository }}\\\" },
                    { key: \\\"RUNNER_NAME\\\",     value: \\\"$RUNNER_LABEL\\\" },
                    { key: \\\"RUNNER_LABELS\\\",   value: \\\"$RUNNER_LABEL\\\" },
                    { key: \\\"RUNNER_SCOPE\\\",    value: \\\"repo\\\" },
                    { key: \\\"EPHEMERAL\\\",       value: \\\"1\\\" }
                  ]
                }) { id }
              }\"
            }")

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© API
          # Validate API response
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âŒ RunPod API error:"
            echo "$RESPONSE" | jq '.errors'
            exit 1
          fi

          POD_ID=$(echo "$RESPONSE" | jq -r '.data.podFindAndDeployOnDemand.id // empty')
          if [ -z "$POD_ID" ]; then
            echo "âŒ Failed to start RunPod pod. Full response:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "pod_id=$POD_ID"         >> $GITHUB_OUTPUT
          echo "runner_label=$RUNNER_LABEL" >> $GITHUB_OUTPUT
          echo "âœ… RunPod pod started: $POD_ID"
          echo "ğŸ·ï¸ Runner label: $RUNNER_LABEL"

      # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ø§Ù„Ù€ runner Ù…ØªØ§Ø­Ø§Ù‹ (ÙØ­Øµ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©ØŒ Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
      # Poll until runner is online (every 15 s, up to 10 minutes)
      - name: Wait for runner to come online
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          RUNNER_LABEL: ${{ steps.start-pod.outputs.runner_label }}
        run: |
          echo "â³ Waiting for RunPod runner ($RUNNER_LABEL) to come online..."
          TIMEOUT=600
          ELAPSED=0
          INTERVAL=15
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(curl -s \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners" \
              | jq -r --arg label "$RUNNER_LABEL" \
                '.runners[] | select(.labels[].name == $label) | .status' 2>/dev/null || true)
            if [ "$STATUS" = "online" ]; then
              echo "âœ… Runner is online!"
              exit 0
            fi
            echo "â³ Not yet online (${ELAPSED}s elapsed), retrying in ${INTERVAL}s..."
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          echo "âŒ Timed out waiting for runner after ${TIMEOUT}s"
          exit 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Ø§Ù„ÙˆØ¸ÙŠÙØ© 2: Ø¨Ù†Ø§Ø¡ Unity Android APK Ø¹Ù„Ù‰ Ø§Ù„Ù€ RunPod runner
  # Job 2: Build Unity Android APK on the RunPod runner
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build Unity Android APK on RunPod
    needs: start-runner
    runs-on: ${{ needs.start-runner.outputs.runner_label }}
    timeout-minutes: 90
    steps:
      # Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù…Ø¹ Git LFS
      # Checkout with LFS (Unity binary assets)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù…ÙƒØªØ¨Ø© Unity Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠ
      # Cache Unity Library folder to speed up future builds
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Android-RunPod-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Android-RunPod-
            Library-Android-
            Library-

      # Ø¨Ù†Ø§Ø¡ APK Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… game-ci/unity-builder
      # Build the Android APK via game-ci/unity-builder (runs Unity inside Docker)
      - name: Build Android APK
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE:  ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL:    ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: 2022.3.22f1
          targetPlatform: Android
          androidExportType: androidPackage
          androidTargetSdkVersion: AndroidApiLevel34
          androidKeystoreName: ${{ secrets.ANDROID_KEYSTORE_BASE64 && 'user.keystore' || '' }}
          androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
          buildName: LHD
          versioning: Semantic

      - name: Upload Unity Editor.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-editor-log
          path: |
            **/Editor.log
            /github/home/.config/unity3d/Editor.log
            /github/home/.local/share/unity3d/Editor.log
            /root/.config/unity3d/Editor.log
            /root/.local/share/unity3d/Editor.log

      # Ø±ÙØ¹ Ù…Ù„Ù APK ÙƒÙ€ artifact (ÙŠÙØ­ÙØ¸ 14 ÙŠÙˆÙ…Ø§Ù‹)
      # Upload APK artifact (kept for 14 days)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LHD-Android-APK-RunPod
          path: build/Android
          retention-days: 14

      # Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
      # Build summary
      - name: Build Summary
        if: always()
        run: |
          echo "ğŸ® Unity Android Build via RunPod â€” Complete!"
          echo "ğŸ”¢ Unity Version : 2022.3.22f1"
          echo "ğŸ“¦ Platform      : Android"
          if [ -d "build/Android" ]; then
            echo "âœ… Build successful"
            echo "ğŸ“ Artifacts:"
            ls -lh build/Android/
          else
            echo "âŒ Build failed â€” build/Android not found"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Ø§Ù„ÙˆØ¸ÙŠÙØ© 3: Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù€ pod Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡) Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
  # Job 3: Always terminate the pod (even on build failure) to avoid charges
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stop-runner:
    name: Stop RunPod Runner
    needs:
      - start-runner
      - build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Terminate RunPod pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          POD_ID: ${{ needs.start-runner.outputs.pod_id }}
        run: |
          TERMINATE_RESPONSE=$(curl -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RUNPOD_API_KEY" \
            "https://api.runpod.io/graphql" \
            --data-raw "{\"query\": \"mutation { podTerminate(input: { podId: \\\"$POD_ID\\\" }) }\"}")
          if echo "$TERMINATE_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âš ï¸ Warning: pod termination returned errors:"
            echo "$TERMINATE_RESPONSE" | jq '.errors'
          else
            echo "ğŸ›‘ Terminated RunPod pod: $POD_ID"
          fi
